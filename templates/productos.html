{% extends "base.html" %}
{% block title %}Catálogo de Productos{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="row g-4">
    <!-- Imagen del producto -->
    <div class="col-md-6 col-12">
      <img src="{{ product.image }}" alt="{{ product.name }}" class="img-fluid rounded shadow-sm w-100">
    </div>

    <!-- Detalles del producto -->
    <div class="col-md-6 col-12">
      <h1 class="mb-3">{{ product.name }}</h1>
      <p class="text-muted mb-4">{{ product.desc }}</p>
      <h3 class="text-primary mb-4">${{ '%.2f'|format(product.price) }}</h3>

      {% if session.get('username') %}
        <form method="POST" action="{{ url_for('add_to_cart', pid=product.id) }}">
          <!-- aquí tu formulario de carrito (tallas, color, cantidad...) -->
        </form>
      {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg w-100">
          Inicia sesión para comprar
        </a>
      {% endif %}

      <!-- ======= Sección de reseñas ======= -->
      <hr class="my-4">
      <div id="productReviewSection" 
           data-product-id="{{ product.id }}" 
           data-current-user="{{ session.get('username') or '' }}">
        
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h4 class="mb-0">Reseñas</h4>
          <div id="ratingsSummary" class="text-end small text-muted">
            <div id="avgText">Cargando reseñas...</div>
          </div>
        </div>

        {% if session.get('username') %}
        <div id="reviewFormWrapper">
          <h5 id="formTitle">Deja una reseña</h5>
          <form id="reviewForm" enctype="multipart/form-data" class="mb-3">
            <input type="hidden" name="id_producto" id="id_producto" value="{{ product.id }}">
            <input type="hidden" name="id_resena" id="id_resena" value="">

            <!-- Calidad -->
            <div class="mb-2">
              <label class="form-label d-block">Calidad</label>
              <div class="star-rating" data-name="calidad" aria-label="Calidad">
                <input type="radio" id="calidad5" name="calidad" value="5"><label for="calidad5">★</label>
                <input type="radio" id="calidad4" name="calidad" value="4"><label for="calidad4">★</label>
                <input type="radio" id="calidad3" name="calidad" value="3"><label for="calidad3">★</label>
                <input type="radio" id="calidad2" name="calidad" value="2"><label for="calidad2">★</label>
                <input type="radio" id="calidad1" name="calidad" value="1"><label for="calidad1">★</label>
              </div>
            </div>

            <!-- Comodidad -->
            <div class="mb-2">
              <label class="form-label d-block">Comodidad</label>
              <div class="star-rating" data-name="comodidad" aria-label="Comodidad">
                <input type="radio" id="comodidad5" name="comodidad" value="5"><label for="comodidad5">★</label>
                <input type="radio" id="comodidad4" name="comodidad" value="4"><label for="comodidad4">★</label>
                <input type="radio" id="comodidad3" name="comodidad" value="3"><label for="comodidad3">★</label>
                <input type="radio" id="comodidad2" name="comodidad" value="2"><label for="comodidad2">★</label>
                <input type="radio" id="comodidad1" name="comodidad" value="1"><label for="comodidad1">★</label>
              </div>
            </div>

            <!-- Comentario -->
            <div class="mb-2">
              <label for="comentario_resena" class="form-label">Comentario</label>
              <textarea id="comentario_resena" name="comentario_resena" class="form-control" rows="3" maxlength="1000"></textarea>
            </div>

            <!-- Foto -->
            <div class="mb-2">
              <label for="foto_comentario" class="form-label">Foto (opcional)</label>
              <input type="file" id="foto_comentario" name="foto_comentario" accept="image/*" class="form-control">
            </div>

            <!-- Botones -->
            <div class="d-flex gap-2 flex-wrap">
              <button type="submit" class="btn btn-success" id="submitBtn">Enviar reseña</button>
              <button type="button" class="btn btn-secondary d-none" id="cancelEditBtn">Cancelar edición</button>
            </div>
          </form>
        </div>
        {% else %}
          <p><a href="{{ url_for('login') }}">Inicia sesión</a> para dejar una reseña.</p>
        {% endif %}

        <hr>
        <div id="reviewsList" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<style>
/* Estrellas */
.star-rating { direction: rtl; display: inline-flex; gap: 6px; font-size: 24px; }
.star-rating input { display:none; }
.star-rating label { cursor:pointer; user-select:none; opacity:0.35; transition:opacity .12s; }
.star-rating input:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label { opacity:1; color:gold; }
.single-review { margin-bottom:12px; }
.single-review .meta { font-size: .9rem; color: #6c757d; }
.single-review .actions { margin-top:6px; }
@media (max-width: 768px) {
  .row { flex-direction: column; }
  .col-md-6 { width: 100%; }
}

</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const section = document.getElementById('productReviewSection');
  if (!section) return;
  const pid = section.dataset.productId;
  const currentUser = (section.dataset.currentUser || '').trim();
  const form = document.getElementById('reviewForm');
  const reviewsList = document.getElementById('reviewsList');
  const avgText = document.getElementById('avgText');
  const idResenaInput = document.getElementById('id_resena');
  const submitBtn = document.getElementById('submitBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');

  let reviewsCache = [];

  async function loadReviews(){
    try {
      const r = await fetch('/api/obtener_reseñas?id_producto=' + encodeURIComponent(pid));
      if (!r.ok) throw new Error('No se pudieron cargar reseñas');
      const data = await r.json();
      reviewsCache = data.reseñas || [];
      renderSummary(reviewsCache);
      renderList(reviewsCache);
      checkUserReview(reviewsCache);
    } catch(e){ 
      console.error(e);
      avgText.textContent = 'No se pudieron cargar las reseñas';
    }
  }

  function renderSummary(list){
    if (!list.length) {
      avgText.innerHTML = 'Sin reseñas aún';
      return;
    }
    const sumQuality = list.reduce((s, x) => s + (Number(x.calidad)||0), 0);
    const sumComfort = list.reduce((s, x) => s + (Number(x.comodidad)||0), 0);
    const avgQuality = (sumQuality / list.length);
    const avgComfort = (sumComfort / list.length);
    // mostrar con 1 decimal
    avgText.innerHTML = `
      <div><strong>${list.length}</strong> reseña(s)</div>
      <div>Calidad: ${avgQuality.toFixed(1)} · Comodidad: ${avgComfort.toFixed(1)}</div>
    `;
  }

  function renderList(list){
    reviewsList.innerHTML = '';
    if (!list.length) {
      reviewsList.innerHTML = '<p class="text-muted">Sé el primero en dejar una reseña.</p>';
      return;
    }
    list.forEach(r => {
      const div = document.createElement('div');
      div.className = 'single-review card p-2 mb-2';
      const userEsc = escapeHtml(r.id_usuario);
      const commentEsc = escapeHtml(r.comentario_resena || '');
      const foto = r.foto_url ? `<img src="${r.foto_url}" alt="foto" style="max-width:180px; display:block; margin-top:6px;">` : '';
      // acciones solo si es el autor
      const isOwner = currentUser && (currentUser === r.id_usuario);
      div.innerHTML = `
        <div class="d-flex justify-content-between">
          <div><strong>${userEsc}</strong> <span class="meta">· ${r.creado_en}</span></div>
          ${isOwner ? '<div class="text-end"><small class="text-muted">Tu reseña</small></div>' : ''}
        </div>
        <div class="mt-1">Calidad: ${stars(r.calidad)} · Comodidad: ${stars(r.comodidad)}</div>
        <p class="mt-2 mb-0">${commentEsc}</p>
        ${foto}
        ${isOwner ? `<div class="actions"><button class="btn btn-sm btn-outline-primary me-2" data-action="edit" data-id="${r.id_resena}">Editar</button><button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${r.id_resena}">Eliminar</button></div>` : ''}
      `;
      reviewsList.appendChild(div);
    });
    // attach listeners for edit/delete
    reviewsList.querySelectorAll('button[data-action]').forEach(btn => {
      btn.addEventListener('click', handleActionClick);
    });
  }

  function checkUserReview(list){
    if (!currentUser) return; // no logueado: nada que hacer
    const mine = list.find(r => r.id_usuario === currentUser);
    if (mine){
      // Ocultar formulario si ya existe reseña; mostrar pequeña nota con opciones (editar/eliminar ya en la lista)
      const wrapper = document.getElementById('reviewFormWrapper');
      if (wrapper) {
        wrapper.querySelectorAll('input,textarea,button').forEach(el => {
          // no removemos el formulario, solo lo ocultamos para prevenir envíos duplicados
          el.disabled = true;
        });
        wrapper.style.opacity = '0.7';
        const note = document.createElement('div');
        note.className = 'alert alert-info mt-2';
        note.id = 'alreadyNote';
        note.innerHTML = `Ya dejaste una reseña para este producto. Usa <strong>Editar</strong> si quieres modificarla.`;
        wrapper.appendChild(note);
      }
    } else {
      // si no existe reseña propia, aseguramos que el formulario esté activo
      const wrapper = document.getElementById('reviewFormWrapper');
      if (wrapper) {
        wrapper.querySelectorAll('input,textarea,button').forEach(el => el.disabled = false);
        wrapper.style.opacity = '1';
        const note = document.getElementById('alreadyNote');
        if (note) note.remove();
      }
    }
  }

  function handleActionClick(e){
    const action = e.currentTarget.dataset.action;
    const id = e.currentTarget.dataset.id;
    if (action === 'edit') {
      startEdit(id);
    } else if (action === 'delete') {
      confirmDelete(id);
    }
  }

  function startEdit(id){
    const r = reviewsCache.find(x => String(x.id_resena) === String(id));
    if (!r) return alert('Reseña no encontrada');
    // habilitar formulario y rellenar
    idResenaInput.value = r.id_resena;
    document.getElementById('comentario_resena').value = r.comentario_resena || '';
    // poner estrellas calidad/comodidad
    const calidadRadio = document.querySelector(`input[name="calidad"][value="${r.calidad}"]`);
    const comodidadRadio = document.querySelector(`input[name="comodidad"][value="${r.comodidad}"]`);
    if (calidadRadio) calidadRadio.checked = true;
    if (comodidadRadio) comodidadRadio.checked = true;

    // cambiar UI a modo edición
    document.getElementById('formTitle').textContent = 'Editar reseña';
    submitBtn.textContent = 'Guardar cambios';
    cancelEditBtn.classList.remove('d-none');
    // habilitar inputs (por si estaban deshabilitados)
    document.querySelectorAll('#reviewForm input, #reviewForm textarea, #reviewForm button').forEach(el => el.disabled = false);
    // scroll to form
    document.getElementById('reviewForm').scrollIntoView({behavior:'smooth', block:'center'});
  }

  cancelEditBtn && cancelEditBtn.addEventListener('click', () => {
    // limpiar modo edición
    idResenaInput.value = '';
    document.getElementById('comentario_resena').value = '';
    document.querySelectorAll('input[name="calidad"], input[name="comodidad"]').forEach(i => i.checked = false);
    document.getElementById('formTitle').textContent = 'Deja una reseña';
    submitBtn.textContent = 'Enviar reseña';
    cancelEditBtn.classList.add('d-none');
  });

  async function confirmDelete(id){
    if (!confirm('¿Estás seguro de eliminar tu reseña? Esta acción no se puede deshacer.')) return;
    try {
      const resp = await fetch('/api/eliminar_reseña', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({id_resena: id})
      });
      const json = await resp.json();
      if (resp.ok && json.success) {
        alert('Reseña eliminada.');
        await loadReviews();
      } else {
        alert('Error al eliminar: ' + (json.message || ''));
      }
    } catch (err) {
      console.error(err);
      alert('Error en la petición de eliminación.');
    }
  }

  if (form){
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);

      // validación mínima
      if (!fd.get('calidad') || !fd.get('comodidad')) {
        alert('Por favor califica calidad y comodidad.');
        return;
      }

      // si id_resena está presente -> editar ruta distinta, sino crear
      const id_resena = fd.get('id_resena');
      const url = id_resena ? '/api/editar_reseña' : '/api/guardar_reseña';
      try {
        const resp = await fetch(url, { method: 'POST', body: fd });
        const json = await resp.json();
        if (resp.ok && json.success){
          // recargar reseñas y limpiar formulario (o salir de modo edición)
          await loadReviews();
          if (id_resena) {
            // salir modo edición
            cancelEditBtn.click();
          } else {
            form.reset();
          }
          alert(json.message || 'Operación exitosa.');
        } else {
          alert('Error: ' + (json.message || 'No se pudo completar.'));
        }
      } catch (err) {
        console.error(err);
        alert('Error en la petición.');
      }
    });
  }

  function stars(n){
    n = Number(n) || 0;
    return '★'.repeat(n) + '☆'.repeat(5-n);
  }
  function escapeHtml(t){
    if (!t) return '';
    return t.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  loadReviews();
});
</script>

{% endblock %}